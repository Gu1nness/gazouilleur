<!DOCTYPE html>
<?xml version="1.0" encoding="UTF-8"?>
<html>
  <head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type"/>
    <title>Gazouilleur's WebMonitor for {{name}}: {{url}}</title>
    <style>
h1 {
  font-size: 22px;
  text-align: center;
}
h2 {
  font-size: 18px;
}
h3 {
  font-size: 14px;
}
#selecter {
  width: 100%;
  height: 240px;
  border: 1px solid black;
  overflow: auto;
  text-align: center;
}
#versions {
  position: sticky;
  top: 0;
  background-color: white;
  height: 22px;
}
#versions p {
  margin: 0px 2px;
  display: block;
  float:left;
  border-bottom: 1px solid black;
  cursor: pointer;
  font-size: 12px;
  font-weight: bold;
}
.selectcopy {
  background-color: lightpink;
}
.selectorig {
  background-color: lightgreen;
}
#screenshots {
  height: 200px;
  display: table;
  overflow: auto;
}
#screenshots img {
  margin: 2px;
  vertical-align: top;
  cursor: pointer;
}
#iframes {
  margin-top: 10px;
  width: 100%;
  height: 475px;
  border: 1px solid black;
}
#copy, #orig {
  float: left;
  width: 50%;
}
#iframes input {
  position: fixed;
}
#iframes #copy input {
  right: 50%;
}
#copy p {
  background-color: lightpink;
}
#orig p {
  background-color: lightgreen;
}
#iframes p {
  margin: auto;
  width: 100%;
  height: 18px;
  display: block;
  border-bottom: 1px solid black;
  text-align: center;
  font-size: 13px;
  padding-top: 4px;
}
iframe {
  margin-top: 2px;
  height: 450px;
  margin: 0;
  border: 0;
}
#orig iframe {
  border-left: 1px solid black;
}
    </style>
  </head>
  <body>
    <h1>
      <a href="https://github.com/RouxRC/gazouilleur">Gazouilleur</a>'s WebMonitor for <a target="_blank" href="{{url}}">{{url}}</a>
    </h1>
    {{#screenshots}}
    <div id="selecter">
      <div id="selecter_large">
        <div id="versions">
        </div>
        <div id="screenshots">
        </div>
      </div>
    </div>
    {{/screenshots}}
    </ul>
    <div id="iframes">
      <div id="copy">
        <input type="radio" name="curwin" value="copy" checked />
        <p><a target="_blank"></a></p>
        <iframe sandbox="allow-same-origin allow-scripts"></iframe>
      </div>
      <div id="orig">
        <input type="radio" name="curwin" value="orig" />
        <p><a target="_blank"></a></p>
        <iframe sandbox="allow-same-origin allow-scripts"></iframe>
      </div>
    </div>
  <!--
    <h2>Diff view</h2>
    <span id="old"></span> Vs. <span id="new"></span>
    <div id="diff"></div>
  -->
  </body>
<script type="text/javascript" src="js/jquery-1.8.2.min.js"></script>
<script type="text/javascript">
(function(ns){
  ns.url = "{{url}}";
  ns.name = "{{name}}";
  ns.versions = "{{versions_str}}".split(",");
  ns.last = ns.versions[ns.versions.length -1];
  ns.currentwin = "copy";
  ns.currentcopy = "";
  ns.currentorig = "";

  ns.buildUrl = function(version, typ){
    return "monitor/"+ns.name+"/"+version+"."+typ;
  };

  ns.nameVersion = function(version){
    return version.replace(/^(..)(..)(..)-(..)(..)$/, "$3/$2/$1 $4:$5");
  };

  ns.loadVersion = function(version){
    var url = ns.buildUrl(version, "html"),
      name = ns.nameVersion(version);
    $(".select" + ns.currentwin).removeClass('select' + ns.currentwin);
    $("#" + version).addClass('select' + ns.currentwin);
    $("#" + ns.currentwin + " a").text(name)
                              .attr("href", url);
    $("#" + ns.currentwin + " iframe").attr("src", url);
    ns['current' + ns.currentwin] = version;
  };

  ns.loadReal = function(){
    var url = ns.url || "http://regardscitoyens.org";
    $(".selectorig").removeClass('selectorig');
    $("#orig a").text("real (iframe) " + url)
                .attr("href", url);
    $("#orig iframe").attr("src", url);
    ns.currentorig = "real";
  };

  ns.toggleCurrentWindow = function(){
    console.log(ns.currentwin);
    if (ns.currentwin === "orig"){
      ns.currentwin = "copy";
    } else {
      ns.currentwin = "orig";
    }
  }

  ns.setDimensions = function(){
    var winW = $("#selecter").innerWidth(),
      imgW = Math.max(200, Math.min(350, parseInt(winW/ns.versions.length)));
    $("#selecter_large").width(ns.versions.length * (imgW + 4));
    $("#versions p, #screenshots img").width(imgW);
    $("#copy iframe, #orig iframe").width((winW - 3) / 2);
  };

  $(document).ready(function(){
    var versions = $("#versions"),
      screens = $("#screenshots");
    ns.versions.forEach(function(version){
      var textVersion = ns.nameVersion(version),
        p = document.createElement('p'),
        i = document.createElement('img'),
        onclic = function(){
          ns.loadVersion(version);
        };
      p.id = version;
      p.textContent = textVersion;
      i.src = "monitor/" + ns.name + "/" + version + "-small.png";
      i.title = textVersion;
      i.alt = textVersion;
      versions.append(p);
      screens.append(i);
      $(p).click(onclic);
      $(i).click(onclic);
    });
    ns.setDimensions();
    $("#selecter").scrollLeft($("#selecter_large").width());
    ns.loadVersion(ns.last);
    ns.loadReal();
    $("input[type=radio][name=curwin]").change(ns.toggleCurrentWindow);
    $(window).resize(ns.setDimensions);
  });

})(window.gazouilleur = window.gazouilleur || {});
/* TODO:
- code differ
- juggle between view and diff modes
- css
*/
</script>
</html>
